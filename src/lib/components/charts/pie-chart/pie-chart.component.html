<div class="pie-container">
  <div class="chart-section">
    <svg
      [attr.width]="config.width"
      [attr.height]="config.height"
      [attr.aria-label]="'CHARTS.PIE.TITLE' | translate" 
      class="pie-chart"
      role="img"
      viewBox="0 0 300 300"
      preserveAspectRatio="xMidYMid meet"
    >
  <g [attr.transform]="'translate(' + center.x + ',' + center.y + ')'">
    @for (segment of segments; track segment.value) {
      <path
        [attr.d]="segment.path"
        [style.fill]="segment.color || 'var(--chart-primary-color)'"
        [class.hovered]="hoveredIndex === segment.index"
        [style.opacity]="hiddenSegments.has(segment.index) ? 0.3 : 1"
        (mouseenter)="onSegmentHover(segment.index)"
        (mouseleave)="onSegmentLeave()"
        [attr.aria-label]="segment.label + ': ' + segment.percentage + '%'"
        role="graphics-symbol"
      />
    }
  </g>

  @if (hoveredIndex !== null) {
    @for (segment of segments; track segment.index) {
      @if (hoveredIndex === segment.index) {
        <g 
          class="tooltip" 
          [attr.transform]="'translate(' + getTooltipPosition(segment).x + ',' + getTooltipPosition(segment).y + ')'"
          [style.--tooltip-width]="tooltipWidth + 'px'"
        >          
          <rect
            [attr.x]="-(tooltipWidth / 2 + 5)"
            y="-30"
            [attr.width]="tooltipWidth + 10"
            height="60"
            rx="4"
            class="tooltip-bg"
          />
          <text 
            y="-10"
            class="tooltip-label"
            [attr.x]="0"
          >
            {{ segment.label | translate }}
          </text>
          <text y="15" class="tooltip-value">
            {{ formatTooltipValue(segment.value, segment.percentage) }}
          </text>
        </g>
      }
    }
  }
    </svg>
  </div>

  <div class="pie-legend">
    @for (segment of segments; track segment.index) {
      <div 
        class="legend-item"
        [class.hidden]="hiddenSegments.has(segment.index)"
        [class.hovered]="hoveredIndex === segment.index"
        (mouseenter)="onSegmentHover(segment.index)"
        (mouseleave)="onSegmentLeave()"
        (click)="config.legendConfig?.interactive && toggleSegment(segment.index)"
      >
        <span 
          class="legend-color"
          [style.background-color]="segment.color || 'var(--chart-primary-color)'"
        ></span>
        <span class="legend-label">{{ segment.label | translate }}</span>
        <span class="legend-value">{{ segment.percentage.toFixed(1) }}%</span>
      </div>
    }
  </div>